name: Make CI

on:
  push:
    branches: [ "branchHTTPservMutli" ]
  pull_request:
    branches: [ "branchHTTPservMutli" ]
  workflow_dispatch:

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    # Build HTTP server
    - name: ./configure
      run: ./configure

    - name: Build and Start Server
      run: |
        make
        nohup ./trigFunc & # Start the server in the background
        sleep 2 # Wait for the server to initialize

    - name: Test elapsed time
      run: |
        # Send a request and capture the response
        elapsed_time=$(curl -s 127.0.0.1:8081/compute)
        echo "Elapsed time: ${elapsed_time} ms"

        # Validate elapsed time range (5000-20000 ms)
        if [ "$elapsed_time" -ge 5000 ] && [ "$elapsed_time" -le 20000 ]; then
          echo "Elapsed time is within the acceptable range."
        else
          echo "Elapsed time is out of range! Expected 5000-20000 milliseconds."
          exit 1
        fi

    # Build Docker image
    - name: Install QEMU
      uses: docker/setup-qemu-action@v3

    - name: Install Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Docker Build List
      run: docker buildx ls

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ vars.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_TOKEN }} 

    # - name: Build and Push Multi-Arch Docker Image
    #   run: |
    #     docker buildx build \
    #       --platform linux/amd64,linux/arm64 \
    #       -t oswaldus/httpserver:multi \
    #       --push .

    - name: Build Dockerfile image for amd64
      run: docker build --platform=linux/amd64 -t oswaldus/httpserver:amd64 --push .

    - name: Build Dockerfile image for arm64
      run: docker build --platform=linux/arm64 -t oswaldus/httpserver:arm64 --push .

    - name: Create Docker image manifest
      run: docker manifest create oswaldus/httpserver:multi \
            --amend oswaldus/httpserver:amd64 \
            --amend oswaldus/httpserver:arm64

    - name: Push manifest to Docker Hub
      run: docker manifest push oswaldus/httpserver:multi
